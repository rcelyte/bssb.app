{% extends "pages/player-profile.base.twig" %}

{% block innerContent %}
    {% if privacyMode %}
        {% if not player.showHistory %}
            <div class="alert">
                <i class="mdi mdi-eye-off"></i>
                <strong>This player has disabled their game history.</strong>
            </div>
        {% else %}
            <div class="alert">
                <i class="mdi mdi-eye-off"></i>
                <strong>This player has never used the Server Browser mod, so their game history is hidden by default.</strong>
            </div>
        {% endif %}
    {% elseif not levelHistory or levelHistory|length == 0 %}
        <div class="alert -minor">
            <i class="mdi mdi-motion-play-outline"></i>
            <strong>No level history found for this user. Check back later.</strong>
        </div>
    {% else %}
        {% set lastHostedGameId = 0 %}
        {% for historyItem in levelHistory %}
            {% set hostedGameId = historyItem.hostedGameId %}
            {% if lastHostedGameId != hostedGameId %}
                <h3 class="server-group-header {% if lastHostedGameId == 0 %}-first{% endif %}">
                    <a href="{{ historyItem.getServerUrl() }}">{{ historyItem.gameName }}</a>
                    <span class="when"><i class="mdi mdi-clock-outline"></i> {{ historyItem.firstSeen|timeago_html|raw }}</span>
                </h3>
                {% set lastHostedGameId = hostedGameId %}
            {% endif %}

            <div class="level-history" style="{% if historyItem.coverUrl %}background-image: url('{{ historyItem.coverUrl }}');{% endif %}">
                <div class="inner">
                    {% if historyItem.coverUrl %}
                        <img class="cover-art" src="{{ historyItem.coverUrl }}" alt="{{ historyItem.historyItemName }}" loading="lazy"/>
                    {% else %}
                        <div class="cover-art dummy-cover-art">
                            <i class="mdi mdi-music"></i>
                        </div>
                    {% endif %}
                    <div class="text">
                        {% if not historyItem.placement or not historyItem.getHasFinished() %}
                            <div class="placement -alone">
                                <i class="mdi mdi-emoticon-sad"></i>
                                <span class="special">{{ historyItem.describeFailReason() }}</span>
                            </div>
                        {% elseif historyItem.placement == 1 and historyItem.playedPlayerCount <= 1 %}
                            <div class="placement -alone">
                                <i class="mdi mdi-timer-sand"></i>
                                <span class="special">Played alone</span>
                            </div>
                        {% else %}
                            <div class="placement -place-{{ historyItem.placement }}">
                                <i class="mdi mdi-trophy-variant"></i>
                                <span class="special">Placed #{{ historyItem.placement }} of {{ historyItem.playedPlayerCount }}</span>
                            </div>
                        {% endif %}
                        <div class="song">
                            <div class="title">
                                <span>{{ historyItem.songName }}</span> <span class="by">by {{ historyItem.songAuthor }}</span>
                            </div>
                            <div class="tags">
                                <span class="tag difficulty -diff-{{ historyItem.difficulty }}">{{ historyItem.describeDifficulty() }}</span>
                                {% if historyItem.characteristic %}
                                    <span class="tag characteristic characteristic-{{ historyItem.characteristic }}">
                                        {% set descr = historyItem.describeCharacteristic() %}
                                        {% set iconUrl = historyItem.getCharacteristicIcon() %}
                                        {% if iconUrl %}
                                            <img src="{{ iconUrl }}" alt="{{ descr }}"/>
                                        {% endif %}
                                        <span>{{ descr }}</span>
                                    </span>
                                {% endif %}
                                <div class="space"></div>
                                {% if historyItem.badgeKey %}
                                    <span class="tag -with-tooltip badge badge-{{ historyItem.badgeKey }}" title="{{ historyItem.badgeSubtitle }}">
                                        {% set descr = historyItem.describeBadge() %}
                                        {% set iconUrl = historyItem.getBadgeIcon() %}
                                        {% if iconUrl %}
                                            <img src="{{ iconUrl }}" alt="{{ descr }}"/>
                                        {% endif %}
                                        <span>{{ descr }}</span>
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% if historyItem.modifiedScore is not null %}
                        <div class="score">
                            <div class="score-rank -rank-{{ historyItem.scoreRank.name }}">{{ historyItem.scoreRank.name }}</div>
                            <div class="score-value">{{ historyItem.modifiedScore|number_format(0, ',', ',') }}</div>
                            {% if historyItem.fullCombo %}
                                <div class="score-combo -full">Full Combo</div>
                            {% else %}
                                <div class="score-combo">Combo Ã— {{ historyItem.maxCombo }}</div>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    {% endif %}
{% endblock %}